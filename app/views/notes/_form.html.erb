<%= form_with model: note, local: true, multipart: true,
              class: "space-y-6",
              data: { controller: "markdown-editor" } do |f| %>

  <!-- Error Messages -->
  <% if note.errors.any? %>
    <%= render "shared/error_message", error_messages: note.errors.full_messages %>
  <% end %>

  <!-- Title Field -->
  <div>
    <%= f.label :title, class: "block text-sm font-medium text-neutral-700 mb-2" %>
    <%= f.text_field :title,
        placeholder: "Enter note title...",
        class: "w-full px-4 py-3 text-lg bg-white border border-neutral-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors" %>
  </div>

  <!-- Folder Selection -->
  <div>
    <%= f.label :folder_id, "Folder", class: "block text-sm font-medium text-neutral-700 mb-2" %>
    <%= f.select :folder_id,
        options_from_collection_for_select(current_user.folders.order(:name), :id, :name, note.folder_id),
        { prompt: "No folder" },
        { class: "w-full px-4 py-3 bg-white border border-neutral-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors" } %>
  </div>

  <!-- Tag Selection -->
  <div>
    <%= f.label :tag_ids, "Tags", class: "block text-sm font-medium text-neutral-700 mb-2" %>
    <div class="border border-neutral-300 rounded-md p-3 bg-white max-h-40 overflow-y-auto">
      <% if current_user.tags.any? %>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          <% current_user.tags.order(:name).each do |tag| %>
            <label class="flex items-center space-x-2 text-sm">
              <%= f.check_box :tag_ids,
                  { multiple: true, checked: note.tag_ids.include?(tag.id) },
                  tag.id,
                  '',
                  { class: "rounded border-neutral-300 text-primary-600 focus:ring-primary-500" } %>
              <span class="text-neutral-700"><%= tag.name %></span>
            </label>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-neutral-500">No tags available. Tags will appear here as you create them.</p>
      <% end %>
    </div>
  </div>

  <!-- Markdown Editor -->
  <div>
    <%= f.label :content, "Content", class: "block text-sm font-medium text-neutral-700 mb-2" %>

    <!-- Editor Tabs -->
    <div class="border border-neutral-300 rounded-md overflow-hidden">
      <!-- Tab Headers -->
      <div class="bg-neutral-100 border-b border-neutral-300 flex">
        <button type="button"
                class="px-4 py-2 text-sm font-medium text-neutral-700 border-r border-neutral-300 bg-white"
                data-markdown-editor-target="writeTab"
                data-action="click->markdown-editor#showWrite">
          Write
        </button>
        <button type="button"
                class="px-4 py-2 text-sm font-medium text-neutral-700 bg-neutral-100"
                data-markdown-editor-target="previewTab"
                data-action="click->markdown-editor#showPreview">
          Preview
        </button>
        <div class="flex-1"></div>
        <div class="px-4 py-2 text-xs text-neutral-500 bg-neutral-100">
          Supports Markdown formatting
        </div>
      </div>

      <!-- Editor Content -->
      <div class="relative">
        <!-- Write Mode -->
        <div data-markdown-editor-target="writePane">
          <%= f.text_area :content,
              placeholder: "Start writing your note...\n\nYou can use Markdown formatting:\n\n# Heading 1\n## Heading 2\n**Bold text**\n*Italic text*\n- List item\n\n[Link text](https://example.com)\n\n```code```",
              rows: 16,
              class: "w-full px-4 py-3 bg-white border-0 resize-none focus:ring-0 focus:outline-none font-mono text-sm leading-relaxed",
              data: {
                markdown_editor_target: "textarea",
                action: "input->markdown-editor#updatePreview"
              } %>
        </div>

        <!-- Preview Mode (hidden by default) -->
        <div class="hidden p-4 min-h-96 bg-white prose prose-neutral max-w-none"
             data-markdown-editor-target="preview">
          <p class="text-neutral-500 italic">Start writing to see preview...</p>
        </div>
      </div>
    </div>

    <!-- Markdown Help -->
    <div class="mt-2">
      <details class="text-xs text-neutral-600">
        <summary class="cursor-pointer hover:text-neutral-800">Markdown formatting help</summary>
        <div class="mt-2 p-3 bg-neutral-50 rounded-md space-y-1">
          <div><code># Heading 1</code> → <strong>Large heading</strong></div>
          <div><code>## Heading 2</code> → <strong>Medium heading</strong></div>
          <div><code>**bold**</code> → <strong>bold text</strong></div>
          <div><code>*italic*</code> → <em>italic text</em></div>
          <div><code>- item</code> → bullet list</div>
          <div><code>[text](url)</code> → clickable link</div>
          <div><code>`code`</code> → inline code</div>
          <div><code>```code block```</code> → code block</div>
        </div>
      </details>
    </div>
  </div>

  <!-- Image Upload -->
  <% image_objects = note.images.map { |image| { id: image.id, url: url_for(image), name: image.blob.filename.to_s } } %>

  <div data-controller="image-dropzone"
       data-image-dropzone-existing-images-value="<%= image_objects.to_json %>">
    <%= f.label :images, class: "block text-sm font-medium text-neutral-700 mb-2" %>

    <!-- Hidden file input -->
    <%= f.file_field :images,
                     multiple: true,
                     accept: "image/*",
                     class: "hidden",
                     data: {
                       image_dropzone_target: "fileInput",
                       action: "change->image-dropzone#fileInputChange"
                     } %>

    <!-- Drop zone -->
    <div class="border-2 border-dashed border-neutral-300 rounded-lg p-8 text-center hover:border-primary-400 transition-colors cursor-pointer"
         data-image-dropzone-target="dropzone"
         data-action="dragover->image-dropzone#dragover dragleave->image-dropzone#dragleave drop->image-dropzone#drop click->image-dropzone#openFileDialog">

      <%= render "shared/svg/add_image" %>

      <p class="mt-4 text-sm text-neutral-600">
        <span class="font-medium text-primary-600">Click to upload</span> or drag and drop images here
      </p>
      <p class="text-xs text-neutral-500 mt-1">PNG, JPG, GIF up to 5MB</p>
    </div>

    <!-- Image previews -->
    <div class="mt-4">
      <div class="flex flex-wrap gap-3" data-image-dropzone-target="previewContainer">
        <!-- Previews will be inserted here by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="flex items-center justify-between pt-6 border-t border-neutral-200">
    <div class="flex items-center space-x-3">
      <%= link_to notes_path,
          class: "inline-flex items-center px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-md hover:bg-neutral-50 hover:cursor-pointer transition-colors" do %>
        Cancel
      <% end %>
    </div>

    <%= f.submit note.persisted? ? "Update Note" : "Create Note",
        class: "inline-flex items-center px-6 py-2 text-sm font-medium text-white bg-primary-700 rounded-md hover:bg-primary-800 focus:ring-2 focus:ring-primary-500 hover:cursor-pointer transition-colors" %>
  </div>
<% end %>
