<%= form_with model: note, local: true, multipart: true,
              class: "space-y-6",
              data: { controller: "markdown-editor" } do |f| %>

  <!-- Error Messages -->
  <% if note.errors.any? %>
    <%= render "shared/error_message", error_messages: note.errors.full_messages %>
  <% end %>

  <!-- Title Field -->
  <div>
    <%= f.label :title, class: "block text-sm font-medium text-neutral-700 mb-2" %>
    <%= f.text_field :title,
        placeholder: "Enter note title...",
        class: "w-full px-4 py-3 bg-white border border-neutral-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors" %>
  </div>

  <!-- Folder Selection -->
  <div>
    <%= f.label :folder_id, "Folder", class: "block text-sm font-medium text-neutral-700 mb-2" %>
    <%= f.select :folder_id,
        options_from_collection_for_select(current_user.folders.order(:name), :id, :name, note.folder_id),
        { prompt: "No folder" },
        { class: "w-full px-4 py-3 bg-white border border-neutral-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors hover:cursor-pointer" } %>
  </div>

  <!-- Tag Selection -->
  <div>
    <%= f.label :tag_ids, "Tags", class: "block text-sm font-medium text-neutral-700 mb-2" %>
    <div class="border border-neutral-300 rounded-md p-3 bg-white max-h-40 overflow-y-auto">
      <% if current_user.tags.any? %>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          <% current_user.tags.order(:name).each do |tag| %>
            <label class="flex items-center space-x-2 text-sm">
              <%= check_box_tag 'note[tag_ids][]',
                  tag.id,
                  note.tag_ids.include?(tag.id),
                  class: "rounded border-neutral-300 text-primary-600 focus:ring-primary-500 hover:cursor-pointer" %>
              <span class="text-neutral-700"><%= tag.name %></span>
            </label>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-neutral-500">No tags available. Tags will appear here as you create them.</p>
      <% end %>
    </div>
  </div>

  <!-- Markdown Editor -->
  <%= render "notes/markdown_editor", f: f %>

  <!-- Image Upload -->
  <% image_objects = note.persisted? ? note.images.map { |image| { id: image.id, url: url_for(image), name: image.blob.filename.to_s } } : [] %>

  <div data-controller="image-dropzone"
       data-image-dropzone-existing-images-value="<%= image_objects.to_json %>">
    <%= f.label :images, class: "block text-sm font-medium text-neutral-700 mb-2" %>

    <!-- Hidden file input -->
    <%= f.file_field :images,
                     multiple: true,
                     accept: "image/*",
                     class: "hidden",
                     data: {
                       image_dropzone_target: "fileInput",
                       action: "change->image-dropzone#fileInputChange"
                     } %>

    <!-- Drop zone -->
    <div class="border-2 border-dashed border-neutral-300 rounded-lg p-8 text-center hover:border-primary-400 transition-colors cursor-pointer"
         data-image-dropzone-target="dropzone"
         data-action="dragover->image-dropzone#dragover dragleave->image-dropzone#dragleave drop->image-dropzone#drop click->image-dropzone#openFileDialog">

      <%= render "shared/svg/add_image" %>

      <p class="mt-4 text-sm text-neutral-600">
        <span class="font-medium text-primary-600">Click to upload</span> or drag and drop images here
      </p>
      <p class="text-xs text-neutral-500 mt-1">PNG, JPG, GIF up to 5MB</p>
    </div>

    <!-- Image previews -->
    <div class="mt-4">
      <div class="flex flex-wrap gap-3" data-image-dropzone-target="previewContainer">
        <!-- Previews will be inserted here by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="flex items-center justify-between pt-6 border-t border-neutral-200">
    <div class="flex items-center space-x-3">
      <%= link_to notes_path,
          class: "inline-flex items-center px-4 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-md hover:bg-neutral-50 hover:cursor-pointer transition-colors" do %>
        Cancel
      <% end %>
    </div>

    <%= f.submit note.persisted? ? "Update Note" : "Create Note",
        class: "inline-flex items-center px-6 py-2 text-sm font-medium text-white bg-primary-700 rounded-md hover:bg-primary-800 focus:ring-2 focus:ring-primary-500 hover:cursor-pointer transition-colors" %>
  </div>
<% end %>
